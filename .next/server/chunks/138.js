"use strict";exports.id=138,exports.ids=[138],exports.modules={7697:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.d(t,{f:()=>useGameDatabase});var i=a(95366),n=a(48421),s=a(82451),l=a(11163),o=a(16689),c=e([n,s]);[n,s]=c.then?(await c)():c;let u=(0,s.atom)([]),m=(0,s.atom)(!1),useGameDatabase=e=>{let[t,a]=(0,o.useState)(null),[r,c]=(0,s.useAtom)(u),[g,h]=(0,s.useAtom)(m),[d,p]=(0,o.useState)(void 0);(0,o.useEffect)(()=>{void 0!==e&&h(e)},[e,h]),(0,o.useEffect)(()=>{let initDatabase=async()=>{let e=await (0,n.openDB)("games",1,{upgrade(e){e.createObjectStore("games",{keyPath:"id",autoIncrement:!0})}});a(e)};initDatabase()},[]);let f=(0,o.useCallback)(async()=>{if(t&&g){let e=await t.getAll("games");c(e)}},[t,g,c]);(0,o.useEffect)(()=>{f()},[f]);let v=(0,o.useCallback)(async e=>{if(!t)throw Error("Database not initialized");let a=(0,i.il)(e),r=await t.add("games",a);return f(),r},[t,f]),b=(0,o.useCallback)(async(e,a)=>{if(!t)throw Error("Database not initialized");let r=await t.get("games",e);if(!r)throw Error("Game not found");await t.put("games",{...r,eval:a}),f()},[t,f]),w=(0,o.useCallback)(async e=>{if(t)return t.get("games",e)},[t]),P=(0,o.useCallback)(async e=>{if(!t)throw Error("Database not initialized");await t.delete("games",e),f()},[t,f]),y=(0,l.useRouter)(),{gameId:k}=y.query;(0,o.useEffect)(()=>{"string"==typeof k?w(parseInt(k)).then(e=>{p(e)}):p(void 0)},[k,p,w]);let C=null!==t;return{addGame:v,setGameEval:b,getGame:w,deleteGame:P,games:r,isReady:C,gameFromUrl:d}};r()}catch(e){r(e)}})},95366:(e,t,a)=>{a.d(t,{Bn:()=>getEvaluateGameParams,FB:()=>uciMoveParams,GC:()=>getGameToSave,Oh:()=>getEvaluationBarValue,Rr:()=>moveLineUciToSan,iD:()=>getMaterialDifference,il:()=>formatGameToDatabase,jT:()=>setGameHeaders,lq:()=>isCheck,nH:()=>isSimplePieceRecapture,pe:()=>getGameFromPgn,rP:()=>getStartingFen,uZ:()=>getIsPieceSacrifice,vW:()=>getCapturedPieces,zT:()=>getWhoIsCheckmated});var r=a(51937),i=a(54259),n=a(99983);let getEvaluateGameParams=e=>{let t=e.history({verbose:!0}),a=t.map(e=>e.before);a.push(t[t.length-1].after);let r=t.map(e=>e.from+e.to+(e.promotion||""));return{fens:a,uciMoves:r}},getGameFromPgn=e=>{let t=new r.Chess;return t.loadPgn(e),t},formatGameToDatabase=e=>{let t=e.header();return{pgn:e.pgn(),event:t.Event,site:t.Site,date:t.Date,round:t.Round??"?",white:{name:t.White,rating:t.WhiteElo?Number(t.WhiteElo):void 0},black:{name:t.Black,rating:t.BlackElo?Number(t.BlackElo):void 0},result:t.Result,termination:t.Termination,timeControl:t.TimeControl}},getGameToSave=(e,t)=>e.history().length?e:setGameHeaders(t),setGameHeaders=(e,t={})=>{e.header("Event","Analyse Chess"),e.header("Site","Analyse Chess"),e.header("Date",new Date().toISOString().split("T")[0].replaceAll("-","."));let{whiteName:a,blackName:r,resigned:i}=t;a&&e.header("White",a),r&&e.header("Black",r);let n=e.header().White||"White",s=e.header().Black||"Black";return i&&(e.header("Result","w"===i?"0-1":"1-0"),e.header("Termination",`${"w"===i?s:n} won by resignation`)),e.isGameOver()&&(e.isCheckmate()&&(e.header("Result","w"===e.turn()?"0-1":"1-0"),e.header("Termination",`${"w"===e.turn()?s:n} won by checkmate`)),e.isInsufficientMaterial()&&(e.header("Result","1/2-1/2"),e.header("Termination","Draw by insufficient material")),e.isStalemate()&&(e.header("Result","1/2-1/2"),e.header("Termination","Draw by stalemate")),e.isThreefoldRepetition()&&(e.header("Result","1/2-1/2"),e.header("Termination","Draw by threefold repetition"))),e},moveLineUciToSan=e=>{let t=new r.Chess(e);return e=>{try{let a=t.move(uciMoveParams(e));return a.san}catch(t){return e}}},getEvaluationBarValue=e=>{let t=(0,i.D)(e),a=e.lines[0];if(a.mate)return{label:`M${Math.abs(a.mate)}`,whiteBarPercentage:t};let r=a.cp;if(!r)return{whiteBarPercentage:t,label:"0.0"};let n=Math.abs(r)/100,s=n.toFixed(1);return s.toString().length>3&&(s=n.toFixed(0)),{whiteBarPercentage:t,label:s}},getWhoIsCheckmated=e=>{let t=new r.Chess(e);return t.isCheckmate()?t.turn():null},uciMoveParams=e=>({from:e.slice(0,2),to:e.slice(2,4),promotion:e.slice(4,5)||void 0}),isSimplePieceRecapture=(e,t)=>{let a=new r.Chess(e),i=t.map(e=>uciMoveParams(e));if(i[0].to!==i[1].to)return!1;let n=a.get(i[0].to);return!!n},getIsPieceSacrifice=(e,t,a)=>{if(!a.length)return!1;let i=new r.Chess(e),n="w"===i.turn(),s=getMaterialDifference(e),l=[t,...a];l.length%2==1&&(l=l.slice(0,-1));let o=1,c={w:[],b:[]};for(let e of l){let t=i.move(uciMoveParams(e));if(t.captured)c[t.color].push(t.captured),o=1;else if(--o<0)break}for(let e of c.w.slice(0))c.b.includes(e)&&(c.b.splice(c.b.indexOf(e),1),c.w.splice(c.w.indexOf(e),1));if(1>=Math.abs(c.w.length-c.b.length)&&c.w.concat(c.b).every(e=>"p"===e))return!1;let u=getMaterialDifference(i.fen()),m=u-s;return(n?m:-m)<0},getMaterialDifference=e=>{let t=new r.Chess(e),a=t.board().flat();return a.reduce((e,t)=>{if(!t)return e;let a=t.type;return"w"===t.color?e+getPieceValue(a):e-getPieceValue(a)},0)},getPieceValue=e=>{switch(e){case"p":return 1;case"n":case"b":return 3;case"r":return 5;case"q":return 9;default:return 0}},getStartingFen=e=>{let t="game"in e?e.game:getGameFromPgn(e.pgn),a=t.history({verbose:!0});return a.length?a[0].before:t.fen()},isCheck=e=>{let t=new r.Chess(e);return t.inCheck()},getCapturedPieces=(e,t)=>{let a={};t===n.Il.White?(a.p=8,a.r=2,a.n=2,a.b=2,a.q=1):(a.P=8,a.R=2,a.N=2,a.B=2,a.Q=1);let r=e.split(" ")[0];for(let e of Object.keys(a)){let t=r.match(RegExp(e,"g"))?.length;t&&(a[e]=(a[e]??0)-t)}return a}},31146:(e,t,a)=>{a.d(t,{Tf:()=>sortLines,cq:()=>parseEvaluationResults,eM:()=>getResultProperty});let parseEvaluationResults=(e,t)=>{let a={lines:[]},r={};for(let t of e){if(t.startsWith("bestmove")){let e=getResultProperty(t,"bestmove");e&&(a.bestMove=e)}if(t.startsWith("info")){let e=getResultPv(t),a=getResultProperty(t,"multipv"),i=getResultProperty(t,"depth");if(!e||!a||!i||r[a]&&parseInt(i)<r[a].depth)continue;let n=getResultProperty(t,"cp"),s=getResultProperty(t,"mate");r[a]={pv:e,cp:n?parseInt(n):void 0,mate:s?parseInt(s):void 0,depth:parseInt(i),multiPv:parseInt(a)}}}return a.lines=Object.values(r).sort(sortLines),t||(a.lines=a.lines.map(e=>({...e,cp:e.cp?-e.cp:e.cp,mate:e.mate?-e.mate:e.mate}))),a},sortLines=(e,t)=>void 0!==e.mate&&void 0!==t.mate?e.mate-t.mate:void 0!==e.mate?-e.mate:void 0!==t.mate?t.mate:(t.cp??0)-(e.cp??0),getResultProperty=(e,t)=>{let a=e.split(" "),r=a.indexOf(t);if(-1!==r&&!(r+1>=a.length))return a[r+1]},getResultPv=e=>{let t=e.split(" "),a=t.indexOf("pv");if(-1!==a&&!(a+1>=t.length))return t.slice(a+1)}},54259:(e,t,a)=>{a.d(t,{D:()=>getPositionWinPercentage,L:()=>getLineWinPercentage});var r=a(63520);let getPositionWinPercentage=e=>getLineWinPercentage(e.lines[0]),getLineWinPercentage=e=>{if(void 0!==e.cp)return getWinPercentageFromCp(e.cp);if(void 0!==e.mate)return getWinPercentageFromMate(e.mate);throw Error("No cp or mate in line")},getWinPercentageFromMate=e=>getWinPercentageFromCp(e*(1/0)),getWinPercentageFromCp=e=>{let t=(0,r.g2)(e,-1e3,1e3);return 50+50*(2/(1+Math.exp(-.00368208*t))-1)}},68835:(e,t,a)=>{a.d(t,{s:()=>getLichessEval,M:()=>getLichessUserRecentGames});var r,i=a(31146);(r||(r={})).NotFound="Not found";let getLichessEval=async(e,t=1)=>{try{let a=new AbortController,n=setTimeout(()=>a.abort(),200),s=await fetch(`https://lichess.org/api/cloud-eval?fen=${e}&multiPv=${t}`,{method:"GET",signal:a.signal});clearTimeout(n);let l=await s.json();if("error"in l){if(l.error===r.NotFound)return{bestMove:"",lines:[]};throw Error(l.error)}let o=l.pvs.map((e,t)=>({pv:e.moves.split(" "),cp:e.cp,mate:e.mate,depth:l.depth,multiPv:t+1}));o.sort(i.Tf);let c="w"===e.split(" ")[1];c||o.reverse();let u=o[0].pv[0],m=o.slice(0,t);return{bestMove:u,lines:m}}catch(e){return console.error(e),{bestMove:"",lines:[]}}},getLichessUserRecentGames=async e=>{let t=await fetch(`https://lichess.org/api/games/user/${e}?until=${Date.now()}&max=50&pgnInJson=true&sort=dateDesc`,{method:"GET",headers:{accept:"application/x-ndjson"}});if(404===t.status)return[];let a=await t.text(),r=a.split("\n").filter(e=>e.length>0).map(e=>JSON.parse(e));return r}},63520:(e,t,a)=>{a.d(t,{VF:()=>getWeightedMean,YE:()=>getHarmonicMean,g2:()=>ceilsNumber,z9:()=>getStandardDeviation});let ceilsNumber=(e,t,a)=>e>a?a:e<t?t:e,getHarmonicMean=e=>{let t=e.reduce((e,t)=>e+1/t,0);return e.length/t},getStandardDeviation=e=>{let t=e.length,a=e.reduce((e,t)=>e+t)/t;return Math.sqrt(e.map(e=>Math.pow(e-a,2)).reduce((e,t)=>e+t)/t)},getWeightedMean=(e,t)=>{if(e.length>t.length)throw Error("Weights array is too short");let a=e.reduce((e,a,r)=>e+a*t[r],0),r=t.slice(0,e.length).reduce((e,t)=>e+t,0);return a/r}},99983:(e,t,a)=>{var r,i,n,s;a.d(t,{Il:()=>s,ZJ:()=>n,g_:()=>i,iR:()=>r}),function(e){e.Pgn="pgn",e.ChessCom="chesscom",e.Lichess="lichess"}(r||(r={})),function(e){e.Stockfish16="stockfish_16",e.Stockfish16NNUE="stockfish_16_nnue",e.Stockfish11="stockfish_11"}(i||(i={})),function(e){e.Blunder="blunder",e.Mistake="mistake",e.Inaccuracy="inaccuracy",e.Good="good",e.Excellent="excellent",e.Best="best",e.Book="book",e.Great="great",e.Brilliant="brilliant"}(n||(n={})),function(e){e.White="w",e.Black="b"}(s||(s={}))}};